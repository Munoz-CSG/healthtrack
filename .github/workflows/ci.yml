name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # Clona el repositorio del proyecto
      - name: Checkout del código
        uses: actions/checkout@v3

      # Configura Java 17 como entorno de ejecución
      - name: Configurar Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # Compila el proyecto y ejecuta pruebas automáticas
      - name: Ejecutar pruebas con Maven
        run: mvn clean test

      # Publica los reportes de pruebas Surefire
      - name: Subir artefactos Surefire
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/

      # Publica los logs generados por pruebas funcionales
      - name: Subir logs de Selenium
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: selenium-logs
          path: selenium-tests/logs/

      # Ejecuta prueba de rendimiento usando JMeter en modo consola
      - name: Ejecutar prueba de rendimiento (JMeter)
        run: |
          mkdir -p jmeter/reporte-html
          jmeter -n -t jmeter/ActualizarPesoPerformance.jmx -l jmeter/resultados.jtl -e -o jmeter/reporte-html

      # Publica el reporte HTML generado por JMeter
      - name: Subir reporte de JMeter
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report
          path: jmeter/reporte-html/